<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>å¤šå·¥ç¨‹æˆæœ¬è©¦ç®—çµ±è¨ˆ </title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- React 18 -->
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

<!-- Babel Standalone -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Chart.js + DataLabels æ’ä»¶ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  
  <!-- Excel åŒ¯å‡ºç”¨ SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body { background-color: #f3f4f6; }
    .print-hidden { display: block; }
    @media print {
      .print-hidden { display: none !important; }
    }
  </style>
</head>

<body>
  <!-- React Root -->
  <div id="root"></div>

  <!-- Main Application Script -->
  <script type="text/babel">
/****************************************************
 * PART 1 â€” å…¨åŸŸå¸¸æ•¸ã€å·¥å…·å‡½å¼ï¼ˆå«é‡‘é¡åƒåˆ†ä½è¡¨ç¤ºï¼‰
 ****************************************************/

// Google Sheet CSV URLs
const CSV_URLS = {
  material: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=0&single=true&output=csv",
  purchase: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=1300343145&single=true&output=csv",
  fabrication: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=1755952578&single=true&output=csv",
  transport: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=11669107&single=true&output=csv",
  install: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=183776968&single=true&output=csv"
};

// é‡‘é¡åƒåˆ†ä½æ ¼å¼åŒ–
function formatMoney(num) {
  if (isNaN(num)) return "0";
  return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// é‡é‡å°æ•¸å…©ä½
function formatWeight(num) {
  if (isNaN(num)) return "0.00";
  return Number(num).toFixed(2);
}

// CSV è§£æ
function parseCSV(text) {
  const lines = text.trim().split("\n");
  const headers = lines[0].split(",");
  return lines.slice(1).map(line => {
    const cols = line.split(",");
    let obj = {};
    headers.forEach((h, i) => obj[h.trim()] = cols[i]?.trim());
    return obj;
  });
}
function parseTransportRow(r) {
  return {
    category: r[0],     // è»Šç¨®
    spec: r[1],         // é …ç›®
    region: r[2],       // åœ°å€ï¼ˆå—/åŒ—/ä¸­ï¼‰
    unit: r[3],         // å–®ä½ï¼ˆå°ï¼‰
    price: Number(r[4] || 0)  // å–®åƒ¹ï¼ˆæ•¸å­—ï¼‰
  };
}

/****************************************************
 * PART X â€” å·¥ç¨‹è³‡æ–™å„²å­˜ / è®€å–
 ****************************************************/

// äº”å¤§æˆæœ¬çš„æ‰‹å‹•èª¿æ•´é è¨­å€¼ï¼ˆæ–°ç‰ˆï¼šç‰©ä»¶çµæ§‹ï¼‰
const defaultManualAdjust = {
  material: 0,
  purchase: 0,
  fabrication: 0,
  transport: 0,
  install: 0
};

// ğŸš€ å¼·åŒ–ç‰ˆï¼šæ°¸ä¸å£æ‰çš„ saveProjects()
function saveProjects(data) {
  try {
    if (!data || typeof data !== "object") return;
    localStorage.setItem("projects_v3", JSON.stringify(data));
  } catch (err) {
    console.error("saveProjects() å¯«å…¥éŒ¯èª¤ï¼š", err);
  }
}

// ğŸš€ å¼·åŒ–ç‰ˆï¼šæ°¸ä¸ç™½å±çš„ loadProjects()
function loadProjects() {
  try {
    const raw = localStorage.getItem("projects_v3");

    // ç¬¬ä¸€æ¬¡ä½¿ç”¨ â†’ å›å‚³ç©ºç‰©ä»¶
    if (!raw) return {};

    const parsed = JSON.parse(raw);

    // å£æ‰è³‡æ–™ â†’ è‡ªå‹•é‡ç½®
    if (!parsed || typeof parsed !== "object") return {};

    // ä¿®è£œæ¯ä¸€å€‹å·¥ç¨‹è³‡æ–™
    for (const key in parsed) {
      const proj = parsed[key];

      // å·¥ç¨‹ä¸å­˜åœ¨ æˆ– çµæ§‹éŒ¯èª¤ â†’ é‡å»º
      if (!proj || typeof proj !== "object") {
        parsed[key] = {
          allItems: [],
          manualAdjustDetail: { ...defaultManualAdjust }
        };
        continue;
      }

      // allItems ä¿è­‰ç‚ºé™£åˆ—
      if (!Array.isArray(proj.allItems)) {
        proj.allItems = [];
      }

      // æ–°ç‰ˆäººå·¥èª¿æ•´æ¬„ä½
      if (!proj.manualAdjustDetail || typeof proj.manualAdjustDetail !== "object") {
        proj.manualAdjustDetail = { ...defaultManualAdjust };
      }
    }

    return parsed;
  } catch (err) {
    console.error("loadProjects() ç™¼ç”ŸéŒ¯èª¤ï¼ŒlocalStorage å¯èƒ½ææ¯€ï¼š", err);
    return {}; // ä¿è­· App ä¸æ›æ‰
  }
}
 /****************************************************
 * PART 2 â€” å¤šå·¥ç¨‹ç®¡ç† ProjectManagerï¼ˆç¬¬ 2 æ®µï¼‰
 ****************************************************/

// å¤šå·¥ç¨‹ç®¡ç†
function ProjectManager({ currentProject, setCurrentProject, projects, setProjects }) {

  // æ–°å¢å·¥ç¨‹
  function addProject() {
    const name = prompt("è«‹è¼¸å…¥å·¥ç¨‹åç¨±ï¼š");
    if (!name) return;

    if (projects[name]) {
      alert("å·¥ç¨‹åç¨±å·²å­˜åœ¨ï¼");
      return;
    }

    const updated = {
      ...projects,
      [name]: {
        allItems: [],
        manualAdjust: 0   // â˜… æ­£ç¢ºå¯«æ³•
      }
    };

    setProjects(updated);
    setCurrentProject(name);
    saveProjects(updated);
  }

  // åˆªé™¤å·¥ç¨‹
  function deleteProject(name) {
    if (!window.confirm(`ç¢ºå®šåˆªé™¤å·¥ç¨‹ã€Œ${name}ã€ï¼Ÿ`)) return;

    const updated = { ...projects };
    delete updated[name];

    const next = Object.keys(updated)[0] || "";
    setProjects(updated);
    setCurrentProject(next);
    saveProjects(updated);
  }

  return (
    <div className="bg-white p-4 rounded shadow mb-4 print-hidden">
      <h2 className="text-lg font-bold mb-3">å·¥ç¨‹ç®¡ç†</h2>

      <div className="flex flex-wrap gap-2">

        {Object.keys(projects).map(key => (
          <button
            key={key}
            onClick={() => setCurrentProject(key)}
            className={
              "px-3 py-1 rounded border " +
              (currentProject === key
                ? "bg-blue-600 text-white border-blue-600"
                : "bg-white text-gray-700 border-gray-400")
            }
          >
            {key}
          </button>
        ))}

        <button
          onClick={addProject}
          className="px-3 py-1 rounded bg-green-600 text-white font-bold"
        >
          ï¼‹ æ–°å¢å·¥ç¨‹
        </button>

        {currentProject && (
          <button
            onClick={() => deleteProject(currentProject)}
            className="px-3 py-1 rounded bg-red-600 text-white"
          >
            åˆªé™¤ç›®å‰å·¥ç¨‹
          </button>
        )}
      </div>
    </div>
  );
}
/****************************************************
 * PART 4 â€” MaterialsPageï¼ˆå«è¨­å‚™åç¨±ï¼‹æ–°å¢ï¼‹åˆªé™¤ï¼‹åˆ—å…§ç·¨è¼¯ï¼‰
 ****************************************************/
function MaterialsPage({ materialDB, projectData, setProjectData }) {

  /* ------------------ æ–°å¢æ¬„ä½ state ------------------ */
  const [equipName, setEquipName] = React.useState("");
  const [category, setCategory] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [length, setLength] = React.useState("");
  const [width, setWidth] = React.useState("");
  const [pcs, setPcs] = React.useState("");

  /* ------------------ ä¸‹æ‹‰è³‡æ–™ ------------------ */
  const categories = React.useMemo(() => {
    const s = new Set();
    materialDB.forEach(r => s.add(r.category));
    return [...s];
  }, [materialDB]);

  const specs = React.useMemo(() => {
    return materialDB.filter(r => r.category === category).map(r => r.spec);
  }, [category, materialDB]);

  const selectedRow = React.useMemo(() => {
    return materialDB.find(r => r.category === category && r.spec === spec);
  }, [category, spec, materialDB]);

  const unitWeight = selectedRow ? Number(selectedRow.weight) : 0;
  const price = selectedRow ? Number(selectedRow.price) : 0;
  const isPlate = category.includes("æ¿");

  /* ------------------ è¨ˆç®—é‡é‡ ------------------ */
  const weight = React.useMemo(() => {
    if (!pcs || !length) return 0;
    if (isPlate && !width) return 0;
    return isPlate
      ? Number(length) * Number(width) * unitWeight * Number(pcs)
      : unitWeight * Number(length) * Number(pcs);
  }, [length, width, pcs, isPlate, unitWeight]);

  const subtotal = Math.round(weight * price);

  /* ========================================================
   * æ–°å¢ææ–™
   * ====================================================== */
  function addToList() {
    if (!category || !spec) {
      alert("è«‹é¸æ“‡åˆ†é¡èˆ‡è¦æ ¼");
      return;
    }
    if (!length || !pcs || (isPlate && !width)) {
      alert("è«‹å®Œæ•´è¼¸å…¥é•·åº¦ / (å¯¬åº¦) / æ•¸é‡");
      return;
    }

    const newItem = {
      type: "ææ–™",
      equipName: equipName || "",
      category,
      spec,
      length: Number(length),
      width: isPlate ? Number(width) : null,
      pcs: Number(pcs),
      unitWeight,
      weight,
      price,
      subtotal
    };

    setProjectData({
      ...projectData,
      allItems: [...projectData.allItems, newItem]
    });

    setEquipName("");
    setSpec("");
    setLength("");
    setWidth("");
    setPcs("");
  }

  /* ========================================================
   * åˆªé™¤
   * ====================================================== */
  function deleteMaterial(idx) {
    const items = projectData.allItems.filter(i => i.type === "ææ–™");
    const target = items[idx];
    const realIndex = projectData.allItems.indexOf(target);

    if (realIndex < 0) return;
    const update = [...projectData.allItems];
    update.splice(realIndex, 1);

    setProjectData({ ...projectData, allItems: update });
  }

  /* ========================================================
   * åˆ—å…§ç·¨è¼¯
   * ====================================================== */
  const [editIndex, setEditIndex] = React.useState(null);
  const [editData, setEditData] = React.useState({});

  function startEdit(idx) {
    const items = projectData.allItems.filter(i => i.type === "ææ–™");
    const item = items[idx];

    const itemSpecs = materialDB
      .filter(r => r.category === item.category)
      .map(r => r.spec);

    setEditData({
      ...item,
      specs: itemSpecs
    });
    setEditIndex(idx);
  }

  function cancelEdit() {
    setEditIndex(null);
    setEditData({});
  }

  function saveEdit(idx) {
    const items = projectData.allItems.filter(i => i.type === "ææ–™");
    const original = items[idx];
    const realIndex = projectData.allItems.indexOf(original);

    const dbRow = materialDB.find(
      r => r.category === editData.category && r.spec === editData.spec
    );

    const unitWeight = Number(dbRow.weight);
    const price = Number(dbRow.price);
    const isPlate = editData.category.includes("æ¿");

    const newWeight = isPlate
      ? Number(editData.length) * Number(editData.width) * unitWeight * Number(editData.pcs)
      : unitWeight * Number(editData.length) * Number(editData.pcs);

    const newSubtotal = Math.round(newWeight * price);

    const newItem = {
      ...editData,
      unitWeight,
      weight: newWeight,
      price,
      subtotal: newSubtotal
    };

    const updated = [...projectData.allItems];
    updated[realIndex] = newItem;

    setProjectData({ ...projectData, allItems: updated });
    cancelEdit();
  }

  /* ========================================================
   * æ’ˆææ–™
   * ====================================================== */
  const materialItems = projectData.allItems.filter(i => i.type === "ææ–™");
  const totalWeight = materialItems.reduce((s, i) => s + (i.weight || 0), 0);

  /* ========================================================
   * Render
   * ====================================================== */
  return (
    <div className="p-4 bg-white rounded shadow">

      <h2 className="text-xl font-bold mb-4">ææ–™</h2>

      {/* â—â— æ–°å¢è³‡æ–™å€ â—â— */}
      <div className="mb-3">
        <label className="font-bold">è¨­å‚™åç¨±ï¼š</label>
        <input
          type="text"
          value={equipName}
          onChange={e => setEquipName(e.target.value)}
          className="border px-2 py-1 rounded ml-2 w-48"
          placeholder="å¯ç•™ç™½"
        />
      </div>

      <div className="mb-3">
        <label className="font-bold">åˆ†é¡ï¼š</label>
        <select
          value={category}
          onChange={e => {
            setCategory(e.target.value);
            setSpec("");
          }}
          className="border px-2 py-1 rounded ml-2"
        >
          <option value="">è«‹é¸æ“‡åˆ†é¡</option>
          {categories.map(c => (
            <option key={c}>{c}</option>
          ))}
        </select>
      </div>

      {category && (
        <div className="mb-3">
          <label className="font-bold">è¦æ ¼ï¼š</label>
          <select
            value={spec}
            onChange={e => setSpec(e.target.value)}
            className="border px-2 py-1 rounded ml-2"
          >
            <option value="">è«‹é¸æ“‡è¦æ ¼</option>
            {specs.map(s => (
              <option key={s}>{s}</option>
            ))}
          </select>
        </div>
      )}

      {category !== "" && (
        <>
          <div className="mb-3">
            <label className="font-bold">é•·åº¦(m)ï¼š</label>
            <input
              type="number"
              value={length}
              onChange={e => setLength(e.target.value)}
              className="border px-2 py-1 rounded ml-2 w-32"
            />
          </div>

          {isPlate && (
            <div className="mb-3">
              <label className="font-bold">å¯¬åº¦(m)ï¼š</label>
              <input
                type="number"
                value={width}
                onChange={e => setWidth(e.target.value)}
                className="border px-2 py-1 rounded ml-2 w-32"
              />
            </div>
          )}

          <div className="mb-3">
            <label className="font-bold">æ•¸é‡ï¼š</label>
            <input
              type="number"
              value={pcs}
              onChange={e => setPcs(e.target.value)}
              className="border px-2 py-1 rounded ml-2 w-32"
            />
          </div>

          <div className="mb-3 p-3 bg-gray-50 border rounded">
            é‡é‡ï¼š<b>{weight.toFixed(2)}</b> kg ï¼ å°è¨ˆï¼š<b>{subtotal.toLocaleString()}</b> å…ƒ
          </div>

          <button
            onClick={addToList}
            className="px-4 py-2 bg-blue-600 text-white rounded font-bold"
          >
            ï¼‹ åŠ å…¥æˆæœ¬æ˜ç´°è¡¨
          </button>
        </>
      )}

      {/* â—â— è¡¨æ ¼åˆ—è¡¨ â—â— */}
      <h3 className="text-lg font-bold mt-6 mb-2">ææ–™æˆæœ¬æ˜ç´°</h3>

      <table className="table-auto w-full border mb-4">
        <thead>
          <tr className="bg-gray-100">
            <th className="border px-2 py-1">è¨­å‚™åç¨±</th>
            <th className="border px-2 py-1">åˆ†é¡</th>
            <th className="border px-2 py-1">è¦æ ¼</th>
            <th className="border px-2 py-1">é•·åº¦(m)</th>
            <th className="border px-2 py-1">å¯¬åº¦(m)</th>
            <th className="border px-2 py-1">æ•¸é‡</th>
            <th className="border px-2 py-1">é‡é‡(kg)</th>
            <th className="border px-2 py-1">å°è¨ˆ(å…ƒ)</th>
            <th className="border px-2 py-1 w-32">æ“ä½œ</th>
          </tr>
        </thead>

        <tbody>
          {materialItems.map((i, idx) => {
            const rowIsPlate = i.category.includes("æ¿");
            const isEdit = idx === editIndex;

            if (isEdit) {
              return (
                <tr key={idx} className="bg-yellow-50">
                  <td className="border px-2 py-1">
                    <input
                      type="text"
                      value={editData.equipName}
                      onChange={e => setEditData({ ...editData, equipName: e.target.value })}
                      className="border px-1 py-1 w-28"
                    />
                  </td>
                  <td className="border px-2 py-1">{i.category}</td>

                  <td className="border px-2 py-1">
                    <select
                      value={editData.spec}
                      onChange={e => setEditData({ ...editData, spec: e.target.value })}
                      className="border px-1 py-1 rounded w-28"
                    >
                      {editData.specs.map(s => (
                        <option key={s}>{s}</option>
                      ))}
                    </select>
                  </td>

                  <td className="border px-2 py-1">
                    <input
                      type="number"
                      value={editData.length}
                      onChange={e => setEditData({ ...editData, length: e.target.value })}
                      className="border px-1 py-1 w-20"
                    />
                  </td>

                  <td className="border px-2 py-1">
                    {rowIsPlate ? (
                      <input
                        type="number"
                        value={editData.width}
                        onChange={e => setEditData({ ...editData, width: e.target.value })}
                        className="border px-1 py-1 w-20"
                      />
                    ) : "â€”"}
                  </td>

                  <td className="border px-2 py-1">
                    <input
                      type="number"
                      value={editData.pcs}
                      onChange={e => setEditData({ ...editData, pcs: e.target.value })}
                      className="border px-1 py-1 w-20"
                    />
                  </td>

                  <td className="border px-2 py-1">{i.weight.toFixed(2)}</td>
                  <td className="border px-2 py-1">{i.subtotal.toLocaleString()}</td>

                  <td className="border px-2 py-1 text-center">
                    <button
                      onClick={() => saveEdit(idx)}
                      className="px-2 py-1 bg-green-600 text-white rounded mr-1"
                    >
                      å„²å­˜
                    </button>
                    <button
                      onClick={cancelEdit}
                      className="px-2 py-1 bg-gray-500 text-white rounded"
                    >
                      å–æ¶ˆ
                    </button>
                  </td>
                </tr>
              );
            }

            /* ä¸€èˆ¬åˆ— */
            return (
              <tr key={idx}>
                <td className="border px-2 py-1">{i.equipName}</td>
                <td className="border px-2 py-1">{i.category}</td>
                <td className="border px-2 py-1">{i.spec}</td>
                <td className="border px-2 py-1">{i.length}</td>
                <td className="border px-2 py-1">{i.width ?? "â€”"}</td>
                <td className="border px-2 py-1">{i.pcs}</td>
                <td className="border px-2 py-1">{i.weight.toFixed(2)}</td>
                <td className="border px-2 py-1">{i.subtotal.toLocaleString()}</td>

                <td className="border px-2 py-1 text-center">
                  <button
                    onClick={() => startEdit(idx)}
                    className="px-2 py-1 bg-yellow-600 text-white rounded mr-1"
                  >
                    ç·¨è¼¯
                  </button>
                  <button
                    onClick={() => deleteMaterial(idx)}
                    className="px-2 py-1 bg-red-600 text-white rounded"
                  >
                    åˆªé™¤
                  </button>
                </td>
              </tr>
            );

          })}
        </tbody>
      </table>

      <div className="font-bold text-right">
        ææ–™ç¸½é‡é‡ï¼š{totalWeight.toFixed(2)} kg
      </div>
    </div>
  );
}
/****************************************************
 * PART X â€” PurchasePageï¼ˆå¸‚è³¼å“ï¼‰
 * å«è¨­å‚™åç¨±ã€åˆ†é¡/å“é …ä¸‹æ‹‰ã€æ–°å¢ã€ç·¨è¼¯ã€åˆªé™¤
 ****************************************************/
function PurchasePage({ purchaseDB, projectData, setProjectData }) {

  /* ------------------ æ–°å¢æ¬„ä½ ------------------ */
  const [equipName, setEquipName] = React.useState("");
  const [category, setCategory] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [qty, setQty] = React.useState("");

  /* ------------------ ä¸‹æ‹‰é¸å–® ------------------ */
  const categories = React.useMemo(() => {
    const s = new Set();
    purchaseDB.forEach(r => s.add(r.category));
    return [...s];
  }, [purchaseDB]);

  const specs = React.useMemo(() => {
    return purchaseDB
      .filter(r => r.category === category)
      .map(r => r.spec);
  }, [category, purchaseDB]);

  const selectedRow = React.useMemo(() => {
    return purchaseDB.find(r => r.category === category && r.spec === spec);
  }, [category, spec]);

  const price = selectedRow ? Number(selectedRow.price) : 0;
  const subtotal = price * Number(qty || 0);

  /* ------------------ æ–°å¢æ˜ç´° ------------------ */
  function addToList() {
    if (!category || !spec || !qty) {
      alert("è«‹å®Œæ•´è¼¸å…¥ï¼");
      return;
    }

    const item = {
      type: "å¸‚è³¼å“",
      equipment: equipName || "",
      category,
      spec,
      qty: Number(qty),
      price,
      subtotal
    };

    const updated = {
      ...projectData,
      allItems: [...projectData.allItems, item]
    };

    setProjectData(updated);

    setSpec("");
    setQty("");
  }

  /* ------------------ æ˜ç´°åˆ—è¡¨ ------------------ */
  const items = projectData.allItems.filter(i => i.type === "å¸‚è³¼å“");

  /* ------------------ ç·¨è¼¯åŠŸèƒ½ ------------------ */
  const [editIndex, setEditIndex] = React.useState(null);
  const [editItem, setEditItem] = React.useState(null);

  function startEdit(idx) {
    const item = items[idx];

    const specs = purchaseDB
      .filter(r => r.category === item.category)
      .map(r => r.spec);

    setEditItem({
      ...item,
      specs
    });

    setEditIndex(idx);
  }

  function cancelEdit() {
    setEditIndex(null);
    setEditItem(null);
  }

  function saveEdit(idx) {
    const old = items[idx];

    const updated = {
      ...old,
      equipment: editItem.equipment,
      spec: editItem.spec,
      qty: Number(editItem.qty),
      price: Number(editItem.price),
      subtotal: Number(editItem.qty) * Number(editItem.price)
    };

    const all = [...projectData.allItems];
    all[projectData.allItems.indexOf(old)] = updated;

    setProjectData({ ...projectData, allItems: all });
    setEditIndex(null);
  }

  /* ------------------ åˆªé™¤ ------------------ */
  function deleteItem(idx) {
    if (!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
    const target = items[idx];

    const updated = projectData.allItems.filter(i => i !== target);
    setProjectData({ ...projectData, allItems: updated });
  }

  /* ------------------ Render ------------------ */
  return (
    <div className="p-4 bg-white rounded shadow">

      <h2 className="text-xl font-bold mb-4">å¸‚è³¼å“</h2>

      {/* è¨­å‚™åç¨± */}
      <div className="mb-3">
        <label className="font-bold">è¨­å‚™åç¨±ï¼š</label>
        <input
          type="text"
          value={equipName}
          onChange={e => setEquipName(e.target.value)}
          className="border px-2 py-1 ml-2 rounded w-48"
          placeholder="å¯ç•™ç™½"
        />
      </div>

      {/* åˆ†é¡ */}
      <div className="mb-3">
        <label className="font-bold">åˆ†é¡ï¼š</label>
        <select
          value={category}
          onChange={e => { setCategory(e.target.value); setSpec(""); }}
          className="border px-2 py-1 ml-2 rounded"
        >
          <option value="">è«‹é¸æ“‡åˆ†é¡</option>
          {categories.map(c => <option key={c}>{c}</option>)}
        </select>
      </div>

      {/* å“é … */}
      {category && (
        <div className="mb-3">
          <label className="font-bold">å“é …ï¼š</label>
          <select
            value={spec}
            onChange={e => setSpec(e.target.value)}
            className="border px-2 py-1 ml-2 rounded"
          >
            <option value="">è«‹é¸æ“‡å“é …</option>
            {specs.map(s => <option key={s}>{s}</option>)}
          </select>
        </div>
      )}

      {/* å–®åƒ¹ */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-3">
          <p>å–®ä½ï¼š{selectedRow.unit}</p>
          <p>å–®åƒ¹ï¼š<b>{price}</b> å…ƒ</p>
        </div>
      )}

      {/* æ•¸é‡ */}
      {selectedRow && (
        <div className="mb-3">
          <label className="font-bold">æ•¸é‡ï¼š</label>
          <input
            type="number"
            value={qty}
            onChange={e => setQty(e.target.value)}
            className="border px-2 py-1 ml-2 rounded w-32"
          />
        </div>
      )}

      {/* å°è¨ˆ */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-4">
          å°è¨ˆï¼š<b>{subtotal.toLocaleString()}</b> å…ƒ
        </div>
      )}

      {/* æ–°å¢æŒ‰éˆ• */}
      <button
        onClick={addToList}
        className="px-4 py-2 bg-blue-600 text-white rounded font-bold"
      >
        ï¼‹ åŠ å…¥æˆæœ¬æ˜ç´°è¡¨
      </button>

      {/* æ˜ç´°è¡¨ */}
      <h3 className="text-lg font-bold mt-6 mb-2">å¸‚è³¼å“æ˜ç´°</h3>

      <table className="w-full border mb-4">
        <thead className="bg-gray-100">
          <tr>
            <th className="border px-2 py-1">è¨­å‚™åç¨±</th>
            <th className="border px-2 py-1">åˆ†é¡</th>
            <th className="border px-2 py-1">å“é …</th>
            <th className="border px-2 py-1">æ•¸é‡</th>
            <th className="border px-2 py-1">å–®åƒ¹</th>
            <th className="border px-2 py-1">å°è¨ˆ</th>
            <th className="border px-2 py-1 w-24">æ“ä½œ</th>
          </tr>
        </thead>

        <tbody>
          {items.map((i, idx) => {
            const isEdit = editIndex === idx;

            if (!isEdit) {
              return (
                <tr key={idx}>
                  <td className="border px-2 py-1">{i.equipment}</td>
                  <td className="border px-2 py-1">{i.category}</td>
                  <td className="border px-2 py-1">{i.spec}</td>
                  <td className="border px-2 py-1">{i.qty}</td>
                  <td className="border px-2 py-1">{i.price}</td>
                  <td className="border px-2 py-1">{i.subtotal.toLocaleString()}</td>
                  <td className="border px-2 py-1 text-center space-x-2">
                    <button
                      onClick={() => startEdit(idx)}
                      className="text-blue-600 font-bold"
                    >
                      ç·¨è¼¯
                    </button>
                    <button
                      onClick={() => deleteItem(idx)}
                      className="text-red-600 font-bold"
                    >
                      åˆªé™¤
                    </button>
                  </td>
                </tr>
              );
            }

            /* ç·¨è¼¯æ¨¡å¼ */
            return (
              <tr key={idx} className="bg-yellow-50">
                <td className="border px-2 py-1">
                  <input
                    type="text"
                    value={editItem.equipment}
                    onChange={e => setEditItem({ ...editItem, equipment: e.target.value })}
                    className="border p-1 w-full"
                  />
                </td>

                <td className="border px-2 py-1">{i.category}</td>

                <td className="border px-2 py-1">
                  <select
                    value={editItem.spec}
                    onChange={e => {
                      const row = purchaseDB.find(
                        r => r.category === i.category && r.spec === e.target.value
                      );
                      setEditItem({
                        ...editItem,
                        spec: e.target.value,
                        price: row ? Number(row.price) : editItem.price
                      });
                    }}
                    className="border px-1 py-1 rounded"
                  >
                    {editItem.specs.map(s => <option key={s}>{s}</option>)}
                  </select>
                </td>

                <td className="border px-2 py-1">
                  <input
                    type="number"
                    value={editItem.qty}
                    onChange={e => setEditItem({ ...editItem, qty: e.target.value })}
                    className="border p-1 w-20"
                  />
                </td>

                <td className="border px-2 py-1">
                  <input
                    type="number"
                    value={editItem.price}
                    onChange={e => setEditItem({ ...editItem, price: e.target.value })}
                    className="border p-1 w-20"
                  />
                </td>

                <td className="border px-2 py-1">
                  {(Number(editItem.qty) * Number(editItem.price)).toLocaleString()}
                </td>

                <td className="border px-2 py-1 text-center space-x-2">
                  <button
                    onClick={() => saveEdit(idx)}
                    className="text-green-600 font-bold"
                  >
                    å„²å­˜
                  </button>
                  <button
                    onClick={cancelEdit}
                    className="text-gray-600 font-bold"
                  >
                    å–æ¶ˆ
                  </button>
                </td>
              </tr>
            );

          })}
        </tbody>
      </table>

    </div>
  );
}
/****************************************************
 * PART 6 â€” FabricationPageï¼ˆè£½ä½œæˆæœ¬ï¼‰
 * âœ” å«è¨­å‚™åç¨±
 * âœ” åˆ—å…§ç·¨è¼¯ï¼ˆå„²å­˜ / å–æ¶ˆï¼‰
 * âœ” åˆªé™¤
 ****************************************************/
function FabricationPage({ fabricationDB, projectData, setProjectData }) {
  const [category, setCategory] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [qty, setQty] = React.useState("");

  /* ä¸‹æ‹‰è³‡æ–™ */
  const categories = React.useMemo(() => {
    return [...new Set(fabricationDB.map(r => r.category))];
  }, [fabricationDB]);

  const specs = React.useMemo(() => {
    return fabricationDB
      .filter(r => r.category === category)
      .map(r => r.spec);
  }, [category, fabricationDB]);

  const selectedRow = React.useMemo(() => {
    return fabricationDB.find(r => r.category === category && r.spec === spec);
  }, [category, spec, fabricationDB]);

  const unitPrice = selectedRow ? Number(selectedRow.price) : 0;
  const subtotal = unitPrice * Number(qty || 0);

  /****************************************************
   * â¤ æ–°å¢
   ****************************************************/
  function addToList() {
    if (!category || !spec || !qty) {
      alert("è«‹å®Œæ•´è¼¸å…¥ï¼");
      return;
    }

    const newItem = {
      type: "è£½ä½œæˆæœ¬",
      category,
      spec,
      qty: Number(qty),
      price: unitPrice,
      subtotal,
      equipment: "" // è¨­å‚™åç¨±æ¬„ä½
    };

    setProjectData({
      ...projectData,
      allItems: [...projectData.allItems, newItem]
    });

    setSpec("");
    setQty("");
  }

  /****************************************************
   * â¤ æ’ˆå…¨éƒ¨è£½ä½œæˆæœ¬
   ****************************************************/
  const items = projectData.allItems.filter(i => i.type === "è£½ä½œæˆæœ¬");

  /****************************************************
   * â¤ åˆ—å…§ç·¨è¼¯æ¨¡å¼
   ****************************************************/
  const [editIndex, setEditIndex] = React.useState(null);
  const [editItem, setEditItem] = React.useState(null);

  function startEdit(idx) {
    const row = items[idx];

    setEditIndex(idx);
    setEditItem({
      ...row
    });
  }

  function cancelEdit() {
    setEditIndex(null);
    setEditItem(null);
  }

  function saveEdit(idx) {
    const old = items[idx];

    const updatedItem = {
      ...old,
      equipment: editItem.equipment,
      qty: Number(editItem.qty),
      price: Number(editItem.price),
      subtotal: Number(editItem.qty) * Number(editItem.price)
    };

    const newAll = [...projectData.allItems];
    newAll[projectData.allItems.indexOf(old)] = updatedItem;

    setProjectData({ ...projectData, allItems: newAll });
    cancelEdit();
  }

  /****************************************************
   * â¤ åˆªé™¤
   ****************************************************/
  function deleteItem(idx) {
    if (!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;

    const target = items[idx];
    const newAll = projectData.allItems.filter(i => i !== target);

    setProjectData({ ...projectData, allItems: newAll });
  }

  /****************************************************
   * â¤ Render UI
   ****************************************************/
  return (
    <div className="p-4 bg-white rounded shadow">

      <h2 className="text-xl font-bold mb-4">è£½ä½œæˆæœ¬</h2>

      {/* æ–°å¢å€ */}
      <div className="mb-3">
        <label className="font-bold">åˆ†é¡ï¼š</label>
        <select
          value={category}
          onChange={e => { setCategory(e.target.value); setSpec(""); }}
          className="border px-2 py-1 ml-2 rounded"
        >
          <option value="">è«‹é¸æ“‡åˆ†é¡</option>
          {categories.map(c => <option key={c}>{c}</option>)}
        </select>
      </div>

      {category && (
        <div className="mb-3">
          <label className="font-bold">é …ç›®ï¼š</label>
          <select
            value={spec}
            onChange={e => setSpec(e.target.value)}
            className="border px-2 py-1 ml-2 rounded"
          >
            <option value="">è«‹é¸æ“‡é …ç›®</option>
            {specs.map(s => <option key={s}>{s}</option>)}
          </select>
        </div>
      )}

      {selectedRow && (
        <div className="bg-gray-50 p-3 border rounded mb-3">
          <p>å–®ä½ï¼š{selectedRow.unit}</p>
          <p>å–®åƒ¹ï¼š<b>{unitPrice.toLocaleString()}</b> å…ƒ</p>
        </div>
      )}

      {selectedRow && (
        <div className="mb-3">
          <label className="font-bold">æ•¸é‡ï¼š</label>
          <input
            type="number"
            value={qty}
            onChange={e => setQty(e.target.value)}
            className="border px-2 py-1 ml-2 w-32 rounded"
          />
        </div>
      )}

      {selectedRow && (
        <div className="bg-gray-50 p-3 border rounded mb-4">
          å°è¨ˆï¼š<b>{subtotal.toLocaleString()}</b> å…ƒ
        </div>
      )}

      <button
        onClick={addToList}
        className="px-4 py-2 bg-blue-600 text-white rounded font-bold"
      >
        ï¼‹ åŠ å…¥æˆæœ¬æ˜ç´°è¡¨
      </button>

      {/* æ˜ç´°å€ */}
      <h3 className="text-lg font-bold mt-6 mb-2">è£½ä½œæˆæœ¬æ˜ç´°</h3>

      <table className="w-full border mb-4">
        <thead className="bg-gray-100">
          <tr>
            <th className="border px-2 py-1">è¨­å‚™åç¨±</th>
            <th className="border px-2 py-1">åˆ†é¡</th>
            <th className="border px-2 py-1">é …ç›®</th>
            <th className="border px-2 py-1">æ•¸é‡</th>
            <th className="border px-2 py-1">å–®åƒ¹</th>
            <th className="border px-2 py-1">å°è¨ˆ</th>
            <th className="border px-2 py-1">æ“ä½œ</th>
          </tr>
        </thead>

        <tbody>
          {items.map((i, idx) => {
            const isEdit = idx === editIndex;

            if (!isEdit) {
              return (
                <tr key={idx}>
                  <td className="border px-2 py-1">{i.equipment || ""}</td>
                  <td className="border px-2 py-1">{i.category}</td>
                  <td className="border px-2 py-1">{i.spec}</td>
                  <td className="border px-2 py-1">{i.qty}</td>
                  <td className="border px-2 py-1">{i.price.toLocaleString()}</td>
                  <td className="border px-2 py-1">{i.subtotal.toLocaleString()}</td>
                  <td className="border px-2 py-1 space-x-2 text-center">
                    <button
                      onClick={() => startEdit(idx)}
                      className="text-blue-600 font-bold"
                    >
                      ç·¨è¼¯
                    </button>
                    <button
                      onClick={() => deleteItem(idx)}
                      className="text-red-600 font-bold"
                    >
                      åˆªé™¤
                    </button>
                  </td>
                </tr>
              );
            }

            return (
              <tr key={idx} className="bg-yellow-50">
                <td className="border px-2 py-1">
                  <input
                    value={editItem.equipment}
                    onChange={e => setEditItem({ ...editItem, equipment: e.target.value })}
                    className="border p-1 w-full"
                  />
                </td>

                <td className="border px-2 py-1">{i.category}</td>
                <td className="border px-2 py-1">{i.spec}</td>

                <td className="border px-2 py-1">
                  <input
                    value={editItem.qty}
                    type="number"
                    onChange={e => setEditItem({ ...editItem, qty: e.target.value })}
                    className="border p-1 w-20"
                  />
                </td>

                <td className="border px-2 py-1">
                  <input
                    value={editItem.price}
                    type="number"
                    onChange={e => setEditItem({ ...editItem, price: e.target.value })}
                    className="border p-1 w-24"
                  />
                </td>

                <td className="border px-2 py-1">
                  {(editItem.qty * editItem.price).toLocaleString()}
                </td>

                <td className="border px-2 py-1 text-center space-x-2">
                  <button
                    onClick={() => saveEdit(idx)}
                    className="text-green-600 font-bold"
                  >
                    å„²å­˜
                  </button>
                  <button
                    onClick={cancelEdit}
                    className="text-gray-600 font-bold"
                  >
                    å–æ¶ˆ
                  </button>
                </td>
              </tr>
            );
          })}
        </tbody>
      </table>

    </div>
  );
}
/****************************************************
 * PART 7 â€” TransportPageï¼ˆé‹è¼¸è²»ç”¨ï¼Œå«æ–°å¢ï¼‹åˆªé™¤ï¼‹ç·¨è¼¯ï¼‰
 ****************************************************/
function TransportPage({ transportDB, projectData, setProjectData }) {

  /* è¼¸å…¥æ¬„ä½ */
  const [category, setCategory] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [region, setRegion] = React.useState("");
  const [qty, setQty] = React.useState("");

  /* ä¸‹æ‹‰å¼ï¼šåˆ†é¡ */
  const categories = React.useMemo(() => {
    const setA = new Set();
    transportDB.forEach(r => setA.add(r.category));
    return [...setA];
  }, [transportDB]);

  /* ä¸‹æ‹‰å¼ï¼šè¦æ ¼ */
  const specs = React.useMemo(() => {
    return transportDB
      .filter(r => r.category === category)
      .map(r => r.spec);
  }, [category, transportDB]);

  /* ä¸‹æ‹‰å¼ï¼šåœ°å€ */
  const regions = React.useMemo(() => {
    const setR = new Set();
    transportDB.forEach(r => setR.add(r.region));
    return [...setR];
  }, [transportDB]);

  /* æ‰¾å‡ºå°æ‡‰åƒ¹æ ¼ */
  const selectedRow = React.useMemo(() => {
    return transportDB.find(
      r => r.category === category && r.spec === spec && r.region === region
    );
  }, [category, spec, region, transportDB]);

  const unitPrice = selectedRow ? Number(selectedRow.price) : 0;
  const subtotal = qty ? unitPrice * Number(qty) : 0;

  /****************************************************
   * æ–°å¢é‹è¼¸è²»ç”¨
   ****************************************************/
  function addToList() {
    if (!category || !spec || !region || !qty) {
      alert("è«‹é¸æ“‡åˆ†é¡ã€è¦æ ¼ã€åœ°å€ä¸¦è¼¸å…¥è¶Ÿæ•¸");
      return;
    }

    const newItem = {
      type: "é‹è¼¸è²»ç”¨",
      category,
      spec,
      region,
      qty: Number(qty),
      unitPrice,
      subtotal
    };

    setProjectData({
      ...projectData,
      allItems: [...projectData.allItems, newItem]
    });

    setCategory("");
    setSpec("");
    setRegion("");
    setQty("");
  }

  /****************************************************
   * åˆªé™¤é‹è¼¸è²»ç”¨
   ****************************************************/
  function deleteItem(idx) {
    const items = projectData.allItems.filter(i => i.type === "é‹è¼¸è²»ç”¨");
    const target = items[idx];
    const realIndex = projectData.allItems.indexOf(target);
    if (realIndex < 0) return;

    const updated = [...projectData.allItems];
    updated.splice(realIndex, 1);

    setProjectData({ ...projectData, allItems: updated });
  }

  /****************************************************
   * ç·¨è¼¯æ¨¡å¼ï¼ˆInline Editï¼‰
   ****************************************************/
  const [editIndex, setEditIndex] = React.useState(null);
  const [editData, setEditData] = React.useState({});

  function startEdit(idx) {
    const items = projectData.allItems.filter(i => i.type === "é‹è¼¸è²»ç”¨");
    const item = items[idx];

    const itemSpecs = transportDB
      .filter(r => r.category === item.category)
      .map(r => r.spec);

    setEditData({
      ...item,
      specs: itemSpecs
    });

    setEditIndex(idx);
  }

  function cancelEdit() {
    setEditIndex(null);
    setEditData({});
  }

  function saveEdit(idx) {
    const items = projectData.allItems.filter(i => i.type === "é‹è¼¸è²»ç”¨");
    const original = items[idx];
    const realIndex = projectData.allItems.indexOf(original);

    /* ç”¨ DB æ‰¾æœ€æ–°å–®åƒ¹ */
    const dbRow = transportDB.find(
      r =>
        r.category === editData.category &&
        r.spec === editData.spec &&
        r.region === editData.region
    );

    const unitPrice = dbRow ? Number(dbRow.price) : 0;
    const subtotal = Number(editData.qty) * unitPrice;

    const newItem = {
      ...editData,
      unitPrice,
      subtotal
    };

    const updated = [...projectData.allItems];
    updated[realIndex] = newItem;

    setProjectData({ ...projectData, allItems: updated });
    cancelEdit();
  }

  /****************************************************
   * é‹è¼¸é …ç›®åˆ—è¡¨
   ****************************************************/
  const items = projectData.allItems.filter(i => i.type === "é‹è¼¸è²»ç”¨");

  return (
    <div className="p-4 bg-white rounded shadow">
      <h2 className="text-xl font-bold mb-4">é‹è¼¸è²»ç”¨</h2>

      {/* æ–°å¢å€ */}
      <div className="mb-3">
        <label className="font-bold">åˆ†é¡ï¼š</label>
        <select
          value={category}
          onChange={e => {
            setCategory(e.target.value);
            setSpec("");
          }}
          className="border px-2 py-1 rounded ml-2"
        >
          <option value="">è«‹é¸æ“‡åˆ†é¡</option>
          {categories.map(c => (
            <option key={c}>{c}</option>
          ))}
        </select>
      </div>

      {category && (
        <div className="mb-3">
          <label className="font-bold">è¦æ ¼ï¼š</label>
          <select
            value={spec}
            onChange={e => setSpec(e.target.value)}
            className="border px-2 py-1 rounded ml-2"
          >
            <option value="">è«‹é¸æ“‡è¦æ ¼</option>
            {specs.map(s => (
              <option key={s}>{s}</option>
            ))}
          </select>
        </div>
      )}

      {category && (
        <div className="mb-3">
          <label className="font-bold">åœ°å€ï¼š</label>
          <select
            value={region}
            onChange={e => setRegion(e.target.value)}
            className="border px-2 py-1 rounded ml-2"
          >
            <option value="">è«‹é¸æ“‡åœ°å€</option>
            {regions.map(r => (
              <option key={r}>{r}</option>
            ))}
          </select>
        </div>
      )}

      {category && (
        <>
          <div className="mb-3">
            <label className="font-bold">è¶Ÿæ•¸ï¼š</label>
            <input
              type="number"
              value={qty}
              onChange={e => setQty(e.target.value)}
              className="border px-2 py-1 rounded ml-2 w-32"
            />
          </div>

          <div className="mb-3 p-3 bg-gray-50 border rounded">
            å–®è¶Ÿè²»ç”¨ï¼š<b>{unitPrice.toLocaleString()}</b> å…ƒ ï¼ å°è¨ˆï¼š  
            <b>{subtotal.toLocaleString()}</b> å…ƒ
          </div>

          <button
            onClick={addToList}
            className="px-4 py-2 bg-blue-600 text-white rounded font-bold"
          >
            ï¼‹ æ–°å¢
          </button>
        </>
      )}

      {/* æ˜ç´°è¡¨ */}
      <h3 className="text-lg font-bold mt-6 mb-2">é‹è¼¸è²»ç”¨æ˜ç´°</h3>

      <table className="table-auto w-full border mb-4">
        <thead>
          <tr className="bg-gray-100">
            <th className="border px-2 py-1">åˆ†é¡</th>
            <th className="border px-2 py-1">è¦æ ¼</th>
            <th className="border px-2 py-1">åœ°å€</th>
            <th className="border px-2 py-1">è¶Ÿæ•¸</th>
            <th className="border px-2 py-1">å–®è¶Ÿè²»ç”¨</th>
            <th className="border px-2 py-1">å°è¨ˆ</th>
            <th className="border px-2 py-1">æ“ä½œ</th>
          </tr>
        </thead>

        <tbody>
          {items.map((i, idx) => {
            const isEdit = editIndex === idx;

            if (isEdit) {
              return (
                <tr key={idx} className="bg-yellow-50">
                  <td className="border px-2 py-1">
                    <select
                      value={editData.category}
                      onChange={e =>
                        setEditData({ ...editData, category: e.target.value })
                      }
                      className="border px-1 py-1"
                    >
                      {categories.map(c => (
                        <option key={c}>{c}</option>
                      ))}
                    </select>
                  </td>

                  <td className="border px-2 py-1">
                    <select
                      value={editData.spec}
                      onChange={e =>
                        setEditData({ ...editData, spec: e.target.value })
                      }
                      className="border px-1 py-1"
                    >
                      {editData.specs.map(s => (
                        <option key={s}>{s}</option>
                      ))}
                    </select>
                  </td>

                  <td className="border px-2 py-1">
                    <select
                      value={editData.region}
                      onChange={e =>
                        setEditData({ ...editData, region: e.target.value })
                      }
                      className="border px-1 py-1"
                    >
                      {regions.map(r => (
                        <option key={r}>{r}</option>
                      ))}
                    </select>
                  </td>

                  <td className="border px-2 py-1">
                    <input
                      type="number"
                      value={editData.qty}
                      onChange={e =>
                        setEditData({ ...editData, qty: e.target.value })
                      }
                      className="border px-1 py-1 w-20"
                    />
                  </td>

                  <td className="border px-2 py-1">{i.unitPrice.toLocaleString()}</td>
                  <td className="border px-2 py-1">{i.subtotal.toLocaleString()}</td>

                  <td className="border px-2 py-1">
                    <button
                      onClick={() => saveEdit(idx)}
                      className="text-green-600 font-bold mr-2"
                    >
                      å„²å­˜
                    </button>
                    <button
                      onClick={cancelEdit}
                      className="text-gray-600 font-bold"
                    >
                      å–æ¶ˆ
                    </button>
                  </td>
                </tr>
              );
            }

            return (
              <tr key={idx}>
                <td className="border px-2 py-1">{i.category}</td>
                <td className="border px-2 py-1">{i.spec}</td>
                <td className="border px-2 py-1">{i.region}</td>
                <td className="border px-2 py-1">{i.qty}</td>
                <td className="border px-2 py-1">{i.unitPrice.toLocaleString()}</td>
                <td className="border px-2 py-1">{i.subtotal.toLocaleString()}</td>

                <td className="border px-2 py-1">
                  <button
                    onClick={() => startEdit(idx)}
                    className="text-blue-600 font-bold mr-2"
                  >
                    ç·¨è¼¯
                  </button>
                  <button
                    onClick={() => deleteItem(idx)}
                    className="text-red-600 font-bold"
                  >
                    åˆªé™¤
                  </button>
                </td>
              </tr>
            );
          })}
        </tbody>
      </table>
    </div>
  );
}
/****************************************************
 * PART 8 â€” InstallPageï¼ˆç¾å ´å®‰è£ï¼‰
 * - è¦æ ¼ä¸‹æ‹‰å¯æ”¹
 * - è‡ªå‹•æŠ“ Google Sheet å–®ä½/åƒ¹æ ¼
 * - å–®åƒ¹å¯æ‰‹å‹•ä¿®æ”¹
 * - ç·¨è¼¯æ¨¡å¼æ”¯æ´ã€Œå„²å­˜ / å–æ¶ˆã€
 ****************************************************/

function InstallPage({ installDB, projectData, setProjectData }) {
  const [category, setCategory] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [qty, setQty] = React.useState("");

  const [editIndex, setEditIndex] = React.useState(null);
  const [editItem, setEditItem] = React.useState(null);

  /***************** å·¥å…·å‡½å¼ *****************/
  function getSpecs(category) {
    return installDB
      .filter(r => r.category === category)
      .map(r => r.spec);
  }

  function findDBRow(category, spec) {
    return installDB.find(r => r.category === category && r.spec === spec);
  }

  /***************** æ–°å¢è³‡æ–™ *****************/
  const selectedRow = React.useMemo(() => {
    return findDBRow(category, spec);
  }, [category, spec]);

  const price = selectedRow ? Number(selectedRow.price) : 0;
  const subtotal = price * Number(qty || 0);

  function addToList() {
    if (!category || !spec || !qty) {
      alert("è«‹å®Œæ•´è¼¸å…¥");
      return;
    }

    const item = {
      type: "ç¾å ´å®‰è£",
      category,
      spec,
      unit: selectedRow?.unit || "",
      qty: Number(qty),
      price,
      subtotal
    };

    const updated = {
      ...projectData,
      allItems: [...projectData.allItems, item]
    };

    setProjectData(updated);

    setSpec("");
    setQty("");
  }

  const items = projectData.allItems.filter(i => i.type === "ç¾å ´å®‰è£");

  /***************** ç·¨è¼¯æ¨¡å¼ *****************/
  function startEdit(idx) {
    const item = items[idx];

    setEditIndex(idx);
    setEditItem({
      category: item.category, // ä¸å¯æ”¹
      spec: item.spec,
      unit: item.unit,
      qty: item.qty,
      price: item.price
    });
  }

  function onChangeSpec(newSpec) {
    const row = findDBRow(editItem.category, newSpec);

    setEditItem(prev => ({
      ...prev,
      spec: newSpec,
      unit: row?.unit || prev.unit,
      price: row ? Number(row.price) : prev.price
    }));
  }

  function saveEdit(idx) {
    const old = items[idx];

    const updatedItem = {
      ...old,
      spec: editItem.spec,
      unit: editItem.unit,
      qty: Number(editItem.qty),
      price: Number(editItem.price),
      subtotal: Number(editItem.qty) * Number(editItem.price)
    };

    const newAll = [...projectData.allItems];
    newAll[projectData.allItems.indexOf(old)] = updatedItem;

    setProjectData({ ...projectData, allItems: newAll });
    setEditIndex(null);
  }

  function cancelEdit() {
    setEditIndex(null);
    setEditItem(null);
  }

  function deleteItem(idx) {
    if (!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;

    const target = items[idx];
    const newAll = projectData.allItems.filter(i => i !== target);
    setProjectData({ ...projectData, allItems: newAll });
  }

  /***************** UI *****************/
  return (
    <div className="p-4 bg-white rounded shadow">
      <h2 className="text-xl font-bold mb-4">ç¾å ´å®‰è£</h2>

      {/* åˆ†é¡ */}
      <div className="mb-3">
        <label className="font-bold">åˆ†é¡ï¼š</label>
        <select
          value={category}
          onChange={e => { setCategory(e.target.value); setSpec(""); }}
          className="border px-2 py-1 rounded ml-2"
        >
          <option value="">è«‹é¸æ“‡</option>
          {[...new Set(installDB.map(r => r.category))].map(c => (
            <option key={c} value={c}>{c}</option>
          ))}
        </select>
      </div>

      {/* è¦æ ¼ */}
      {category && (
        <div className="mb-3">
          <label className="font-bold">è¦æ ¼ï¼š</label>
          <select
            value={spec}
            onChange={e => setSpec(e.target.value)}
            className="border px-2 py-1 rounded ml-2"
          >
            <option value="">è«‹é¸æ“‡è¦æ ¼</option>
            {getSpecs(category).map(s => (
              <option key={s} value={s}>{s}</option>
            ))}
          </select>
        </div>
      )}

      {/* é¡¯ç¤ºå–®ä½ã€å–®åƒ¹ */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-3">
          <p>å–®ä½ï¼š{selectedRow.unit}</p>
          <p>å–®åƒ¹ï¼š{selectedRow.price}</p>
        </div>
      )}

      {/* æ•¸é‡ */}
      {selectedRow && (
        <div className="mb-3">
          <label className="font-bold">æ•¸é‡ï¼š</label>
          <input
            type="number"
            value={qty}
            onChange={e => setQty(e.target.value)}
            className="border px-2 py-1 rounded ml-2 w-32"
          />
        </div>
      )}

      {/* å°è¨ˆ */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-4">
          å°è¨ˆï¼š<b>{subtotal.toLocaleString()}</b> å…ƒ
        </div>
      )}

      {/* åŠ å…¥ */}
      <button
        onClick={addToList}
        className="px-4 py-2 bg-blue-600 text-white rounded font-bold"
      >
        ï¼‹ åŠ å…¥æˆæœ¬æ˜ç´°è¡¨
      </button>

      {/* æ˜ç´° */}
      <h3 className="mt-6 mb-2 text-lg font-bold">ç¾å ´å®‰è£æ˜ç´°</h3>

      <table className="w-full border mb-4">
        <thead className="bg-gray-100">
          <tr>
            <th className="border px-2 py-1">åˆ†é¡</th>
            <th className="border px-2 py-1">è¦æ ¼</th>
            <th className="border px-2 py-1">å–®ä½</th>
            <th className="border px-2 py-1">æ•¸é‡</th>
            <th className="border px-2 py-1">å–®åƒ¹</th>
            <th className="border px-2 py-1">å°è¨ˆ</th>
            <th className="border px-2 py-1">æ“ä½œ</th>
          </tr>
        </thead>

        <tbody>
          {items.map((i, idx) => {
            const isEdit = editIndex === idx;

            if (!isEdit) {
              return (
                <tr key={idx}>
                  <td className="border px-2 py-1">{i.category}</td>
                  <td className="border px-2 py-1">{i.spec}</td>
                  <td className="border px-2 py-1">{i.unit}</td>
                  <td className="border px-2 py-1">{i.qty}</td>
                  <td className="border px-2 py-1">{i.price}</td>
                  <td className="border px-2 py-1">{i.subtotal.toLocaleString()}</td>
                  <td className="border px-2 py-1 space-x-2">
                    <button
                      onClick={() => startEdit(idx)}
                      className="text-blue-600 font-bold"
                    >
                      ç·¨è¼¯
                    </button>
                    <button
                      onClick={() => deleteItem(idx)}
                      className="text-red-600 font-bold"
                    >
                      åˆªé™¤
                    </button>
                  </td>
                </tr>
              );
            }

            return (
              <tr key={idx} className="bg-yellow-50">
                <td className="border px-2 py-1">{i.category}</td>

                <td className="border px-2 py-1">
                  <select
                    value={editItem.spec}
                    onChange={e => onChangeSpec(e.target.value)}
                    className="border px-1 py-1 rounded"
                  >
                    {getSpecs(editItem.category).map(s => (
                      <option key={s} value={s}>{s}</option>
                    ))}
                  </select>
                </td>

                <td className="border px-2 py-1">{editItem.unit}</td>

                <td className="border px-2 py-1">
                  <input
                    type="number"
                    value={editItem.qty}
                    onChange={e =>
                      setEditItem({ ...editItem, qty: e.target.value })
                    }
                    className="border px-1 py-1 w-20"
                  />
                </td>

                <td className="border px-2 py-1">
                  <input
                    type="number"
                    value={editItem.price}
                    onChange={e =>
                      setEditItem({ ...editItem, price: e.target.value })
                    }
                    className="border px-1 py-1 w-24"
                  />
                </td>

                <td className="border px-2 py-1">
                  {(Number(editItem.qty) * Number(editItem.price)).toLocaleString()}
                </td>

                <td className="border px-2 py-1 space-x-2">
                  <button
                    onClick={() => saveEdit(idx)}
                    className="text-green-600 font-bold"
                  >
                    å„²å­˜
                  </button>
                  <button
                    onClick={cancelEdit}
                    className="text-gray-600 font-bold"
                  >
                    å–æ¶ˆ
                  </button>
                </td>
              </tr>
            );
          })}
        </tbody>
      </table>
    </div>
  );
}
/****************************************************
 * PART 9 â€” SummaryPageï¼ˆç¸½è¡¨ï¼‰
 ****************************************************/
function SummaryPage({ projectData, currentProject, updateProjectData }) {
  const chartRef = React.useRef(null);

  /*************** äº”å¤§é¡æˆæœ¬å°è¨ˆ ***************/
  const sumByType = (type) =>
    projectData.allItems
      .filter((i) => i.type === type)
      .reduce((a, b) => a + (b.subtotal || 0), 0);

  const materialSum = sumByType("ææ–™");
  const purchaseSum = sumByType("å¸‚è³¼å“");
  const fabSum = sumByType("è£½ä½œæˆæœ¬");
  const transSum = sumByType("é‹è¼¸è²»ç”¨");
  const installSum = sumByType("ç¾å ´å®‰è£");

  const fiveTotal = materialSum + purchaseSum + fabSum + transSum + installSum;

  /*************** äººå·¥èª¿æ•´æ¬„ä½ ***************/
  const manualAdjustDetail = projectData.manualAdjustDetail || {
    material: 0,
    purchase: 0,
    fabrication: 0,
    transport: 0,
    install: 0,
  };

  const manualTotal = Object.values(manualAdjustDetail).reduce(
    (a, b) => a + Number(b || 0),
    0
  );

  const finalCost = fiveTotal + manualTotal; // æˆæœ¬åˆè¨ˆ

  /*************** ç®¡éŠ· / æ¯›åˆ© / å”®åƒ¹ ***************/
  const [adminRate, setAdminRate] = React.useState(15);
  const [profitRate, setProfitRate] = React.useState(35);

  const adminFee = Math.round(finalCost * (adminRate / 100));
  const suggestPrice = Math.round(
    (finalCost + adminFee) / (1 - profitRate / 100)
  );

  const profitAmount = suggestPrice - finalCost - adminFee; // åˆ©æ½¤é¡ (ç¶ è‰²æ¡†)

  /*************** æ›´æ–°äººå·¥èª¿æ•´ ***************/
  function updateManualAdjust(field, value) {
    const num = value === "" ? "" : Number(value);

    const newDetail = {
      ...manualAdjustDetail,
      [field]: num,
    };

    updateProjectData({
      ...projectData,
      manualAdjustDetail: newDetail,
    });
  }

  /*************** åœ“é¤…åœ– ***************/
  React.useEffect(() => {
    const ctx = document.getElementById("summaryChart");
    if (!ctx) return;

    if (window.summaryChart && typeof window.summaryChart.destroy === "function") {
      window.summaryChart.destroy();
    }

    const data = [materialSum, purchaseSum, fabSum, transSum, installSum];
    const labels = ["ææ–™", "å¸‚è³¼å“", "è£½ä½œ", "é‹è¼¸", "å®‰è£"];

    window.summaryChart = new Chart(ctx, {
      type: "pie",
      data: {
        labels,
        datasets: [
          {
            data,
            backgroundColor: [
              "#4fa3d1",
              "#ffcc66",
              "#66cc99",
              "#ff6666",
              "#9999ff",
            ],
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: "bottom" },
          datalabels: {
            color: "#000",
            font: { weight: "bold", size: 16 },
            formatter: (value) => {
              const total = data.reduce((a, b) => a + b, 0);
              return total === 0
                ? "0%"
                : ((value / total) * 100).toFixed(1) + "%";
            },
          },
        },
      },
      plugins: [ChartDataLabels],
    });
  }, [materialSum, purchaseSum, fabSum, transSum, installSum]);

  /****************************************************
   * åŒ¯å‡º Excelï¼ˆå«è¨­å‚™åç¨± equipmentï¼‰
   ****************************************************/
  function exportExcel() {
    const wb = XLSX.utils.book_new();

    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, "0");
    const dd = String(today.getDate()).padStart(2, "0");

    const projectName = currentProject || "æœªå‘½åå·¥ç¨‹";
    const fileName = `${yyyy}${mm}${dd}-${projectName}-æˆæœ¬åˆ†æ.xlsx`;

    const rows = [];

    /************************************
     * ææ–™
     ************************************/
    rows.push(["ææ–™æˆæœ¬æ˜ç´°è¡¨"]);
    rows.push(["è¨­å‚™åç¨±", "åˆ†é¡", "è¦æ ¼", "é•·m", "å¯¬m", "æ•¸é‡", "é‡é‡", "å–®åƒ¹", "å°è¨ˆ"]);

    projectData.allItems
      .filter((i) => i.type === "ææ–™")
      .forEach((i) =>
        rows.push([
          i.equipment || "",
          i.category,
          i.spec,
          i.length || "",
          i.width || "",
          i.pcs,
          i.weight || "",
          i.price,
          i.subtotal,
        ])
      );
    rows.push(["åˆè¨ˆ", "", "", "", "", "", "", "", materialSum]);
    rows.push([]);

    /************************************
     * å¸‚è³¼å“
     ************************************/
    rows.push(["å¸‚è³¼å“æˆæœ¬æ˜ç´°è¡¨"]);
    rows.push(["è¨­å‚™åç¨±", "åˆ†é¡", "å“é …", "æ•¸é‡", "å–®åƒ¹", "å°è¨ˆ"]);

    projectData.allItems
      .filter((i) => i.type === "å¸‚è³¼å“")
      .forEach((i) =>
        rows.push([
          i.equipment || "",
          i.category,
          i.spec,
          i.qty,
          i.price,
          i.subtotal,
        ])
      );
    rows.push(["åˆè¨ˆ", "", "", "", "", purchaseSum]);
    rows.push([]);

    /************************************
     * è£½ä½œ
     ************************************/
    rows.push(["è£½ä½œæˆæœ¬æ˜ç´°è¡¨"]);
    rows.push(["è¨­å‚™åç¨±", "åˆ†é¡", "é …ç›®", "æ•¸é‡", "å–®åƒ¹", "å°è¨ˆ"]);

    projectData.allItems
      .filter((i) => i.type === "è£½ä½œæˆæœ¬")
      .forEach((i) =>
        rows.push([
          i.equipment || "",
          i.category,
          i.spec,
          i.qty,
          i.price,
          i.subtotal,
        ])
      );
    rows.push(["åˆè¨ˆ", "", "", "", "", fabSum]);
    rows.push([]);

    /************************************
     * é‹è¼¸
     ************************************/
    rows.push(["é‹è¼¸æˆæœ¬æ˜ç´°è¡¨"]);
    rows.push(["è¨­å‚™åç¨±", "åˆ†é¡", "é …ç›®", "åœ°å€", "æ•¸é‡", "å–®åƒ¹", "å°è¨ˆ"]);

    projectData.allItems
      .filter((i) => i.type === "é‹è¼¸è²»ç”¨")
      .forEach((i) =>
        rows.push([
          i.equipment || "",
          i.category,
          i.spec,
          i.region,
          i.qty,
          i.price,
          i.subtotal,
        ])
      );
    rows.push(["åˆè¨ˆ", "", "", "", "", "", transSum]);
    rows.push([]);

    /************************************
     * ç¾å ´å®‰è£
     ************************************/
    rows.push(["ç¾å ´å®‰è£æˆæœ¬æ˜ç´°è¡¨"]);
    rows.push(["è¨­å‚™åç¨±", "åˆ†é¡", "è¦æ ¼", "æ•¸é‡", "å–®åƒ¹", "å°è¨ˆ"]);

    projectData.allItems
      .filter((i) => i.type === "ç¾å ´å®‰è£")
      .forEach((i) =>
        rows.push([
          i.equipment || "",
          i.category,
          i.spec,
          i.qty,
          i.price,
          i.subtotal,
        ])
      );
    rows.push(["åˆè¨ˆ", "", "", "", "", installSum]);
    rows.push([]);

    /************************************
     * æˆæœ¬ç¸½è¡¨
     ************************************/
    rows.push(["", "é …ç›®", "é‡‘é¡"]);
    rows.push(["", "äº”å¤§æˆæœ¬åˆè¨ˆ", fiveTotal]);
    rows.push(["", "äººå·¥èª¿æ•´åˆè¨ˆ", manualTotal]);
    rows.push(["", "æˆæœ¬åˆè¨ˆ", finalCost]);
    rows.push(["", "ç®¡éŠ·ç‡(%)", adminRate]);
    rows.push(["", "ç®¡éŠ·è²»", adminFee]);
    rows.push(["", "æ¯›åˆ©ç‡(%)", profitRate]);
    rows.push(["", "å»ºè­°å”®åƒ¹", suggestPrice]);
    rows.push(["", "é è¨ˆåˆ©æ½¤", profitAmount]);

    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, "æˆæœ¬åˆ†æ");

    XLSX.writeFile(wb, fileName);
  }

  /****************************************************
   * RETURN UIï¼ˆå«ä½ è¦æ±‚çš„ç´…è‰²å”®åƒ¹ + æˆæœ¬åˆè¨ˆ + ç¶ è‰²åˆ©æ½¤ï¼‰
   ****************************************************/
  return (
    <div className="p-4 max-w-5xl mx-auto">
      <h2 className="text-2xl font-bold mb-4">æˆæœ¬ç¸½è¡¨</h2>

      {/* åœ“é¤…åœ– */}
      <div className="w-full h-80 mb-6">
        <canvas id="summaryChart"></canvas>
      </div>

      {/* äº”å¤§æˆæœ¬ + äººå·¥èª¿æ•´ */}
      <div className="bg-white p-4 rounded shadow mb-4">
        <h3 className="font-bold text-lg mb-2">äº”å¤§æˆæœ¬ + äººå·¥èª¿æ•´</h3>

        <div className="grid grid-cols-2 gap-3">
          <div><p>ææ–™æˆæœ¬ï¼š{materialSum.toLocaleString()}</p></div>
          <div>
            <label>äººå·¥èª¿æ•´ï¼š
              <input
                type="number"
                value={manualAdjustDetail.material}
                onChange={(e) => updateManualAdjust("material", e.target.value)}
                className="border p-1 w-full"
              />
            </label>
          </div>

          <div><p>å¸‚è³¼å“æˆæœ¬ï¼š{purchaseSum.toLocaleString()}</p></div>
          <div>
            <label>äººå·¥èª¿æ•´ï¼š
              <input
                type="number"
                value={manualAdjustDetail.purchase}
                onChange={(e) => updateManualAdjust("purchase", e.target.value)}
                className="border p-1 w-full"
              />
            </label>
          </div>

          <div><p>è£½ä½œæˆæœ¬ï¼š{fabSum.toLocaleString()}</p></div>
          <div>
            <label>äººå·¥èª¿æ•´ï¼š
              <input
                type="number"
                value={manualAdjustDetail.fabrication}
                onChange={(e) => updateManualAdjust("fabrication", e.target.value)}
                className="border p-1 w-full"
              />
            </label>
          </div>

          <div><p>é‹è¼¸è²»ç”¨ï¼š{transSum.toLocaleString()}</p></div>
          <div>
            <label>äººå·¥èª¿æ•´ï¼š
              <input
                type="number"
                value={manualAdjustDetail.transport}
                onChange={(e) => updateManualAdjust("transport", e.target.value)}
                className="border p-1 w-full"
              />
            </label>
          </div>

          <div><p>ç¾å ´å®‰è£æˆæœ¬ï¼š{installSum.toLocaleString()}</p></div>
          <div>
            <label>äººå·¥èª¿æ•´ï¼š
              <input
                type="number"
                value={manualAdjustDetail.install}
                onChange={(e) => updateManualAdjust("install", e.target.value)}
                className="border p-1 w-full"
              />
            </label>
          </div>
        </div>

        {/* å°è¨ˆ */}
        <div className="mt-4">
          <p className="font-bold">äººå·¥èª¿æ•´å°è¨ˆï¼š{manualTotal.toLocaleString()}</p>
          <p className="font-bold text-lg">æˆæœ¬åˆè¨ˆï¼š{finalCost.toLocaleString()}</p>
        </div>
      </div>

      {/* ç®¡éŠ·ã€æ¯›åˆ©ç‡ã€å»ºè­°å”®åƒ¹ */}
<div className="bg-white p-4 rounded shadow mb-4">
  <div className="grid grid-cols-2 gap-2 mt-2">

    <label>ç®¡éŠ·(%)
      <input
        type="number"
        value={adminRate}
        onChange={(e) => setAdminRate(Number(e.target.value))}
        className="border p-1 w-full"
      />
    </label>

    <p>ç®¡éŠ·è²»ï¼š{adminFee.toLocaleString()} å…ƒ</p>

    <label>æ¯›åˆ©ç‡(%)
      <input
        type="number"
        value={profitRate}
        onChange={(e) => setProfitRate(Number(e.target.value))}
        className="border p-1 w-full"
      />
    </label>

    {/* 1ï¸âƒ£ æœ€çµ‚æˆæœ¬ï¼ˆå«ç®¡éŠ·ï¼‰ â†’ é»‘è‰² */}
    <p className="font-bold text-lg text-black">
      æœ€çµ‚æˆæœ¬ï¼ˆå«ç®¡éŠ·ï¼‰ï¼š{(finalCost + adminFee).toLocaleString()} å…ƒ
    </p>

    {/* 2ï¸âƒ£ å»ºè­°å”®åƒ¹ â†’ ç´…è‰² */}
    <p className="font-bold text-xl text-red-600">
      å»ºè­°å”®åƒ¹ï¼š{suggestPrice.toLocaleString()} å…ƒ
    </p>

  </div>

  {/* é è¨ˆåˆ©æ½¤ */}
  <div className="mt-3">
    <p className="font-bold text-green-600 text-lg">
      é è¨ˆåˆ©æ½¤ï¼š{(suggestPrice - (finalCost + adminFee)).toLocaleString()} å…ƒ
    </p>
  </div>
</div>

      {/* åŒ¯å‡º Excel + åˆ—å° */}
      <div className="flex gap-3 print-hidden mt-4">
        <button
          onClick={exportExcel}
          className="bg-green-600 text-white px-4 py-2 rounded shadow"
        >
          åŒ¯å‡º Excel
        </button>

        <button
          onClick={() => window.print()}
          className="bg-gray-700 text-white px-4 py-2 rounded shadow"
        >
          åˆ—å°
        </button>
      </div>
    </div>
  );
}
/****************************************************
 * PART X â€” BackupAreaï¼ˆç°¡æ˜“ç‰ˆå‚™ä»½ / åŒ¯å…¥ï¼‰
 ****************************************************/
function BackupArea({ projects, setProjects, setCurrentProject }) {

  /* åŒ¯å‡º JSON å‚™ä»½ */
  function exportBackup() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, "0");
    const dd = String(today.getDate()).padStart(2, "0");

    const fileName = `${yyyy}-${mm}-${dd}-Herhsin-CostBackup.json`;

    const blob = new Blob([JSON.stringify(projects, null, 2)], {
      type: "application/json",
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = fileName;
    a.click();
    URL.revokeObjectURL(url);

    alert("âœ… å·²åŒ¯å‡ºå·¥ç¨‹å‚™ä»½");
  }

  /* åŒ¯å…¥ JSON */
  function importBackup(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (evt) => {
      try {
        const json = JSON.parse(evt.target.result);

        if (typeof json !== "object") {
          alert("âŒ åŒ¯å…¥å¤±æ•—ï¼šæ ¼å¼ä¸æ­£ç¢º");
          return;
        }

        setProjects(json);

        const first = Object.keys(json)[0] || "";
        setCurrentProject(first);

        saveProjects(json);

        alert("âœ… åŒ¯å…¥æˆåŠŸï¼å·¥ç¨‹è³‡æ–™å·²é‚„åŸ");
      } catch (err) {
        alert("âŒ åŒ¯å…¥éŒ¯èª¤ï¼šä¸æ˜¯æœ‰æ•ˆ JSON");
      }
    };
    reader.readAsText(file);
  }

  return (
    <div className="p-3 bg-gray-100 border rounded mb-4">
      <h3 className="font-bold mb-2">å·¥ç¨‹å‚™ä»½ / é‚„åŸ</h3>

      <div className="flex gap-3">
        {/* åŒ¯å‡º */}
        <button
          onClick={exportBackup}
          className="px-3 py-1 bg-green-600 text-white rounded"
        >
          åŒ¯å‡º JSON å‚™ä»½
        </button>

        {/* åŒ¯å…¥ */}
        <label className="px-3 py-1 bg-blue-600 text-white rounded cursor-pointer">
          åŒ¯å…¥ JSON
          <input
            type="file"
            accept="application/json"
            className="hidden"
            onChange={importBackup}
          />
        </label>
      </div>
    </div>
  );
}    

/****************************************************
 * PART 10 â€” Appï¼ˆä¸»æ§åˆ¶ï¼‰- è³‡æ–™ä¿è­·åŠ å¼·ç‰ˆ
 * ä¿®æ­£ï¼šé˜²æ­¢è¼¸å…¥è³‡æ–™å¾Œè¢«é›²ç«¯èˆŠè³‡æ–™è¦†è“‹
 ****************************************************/
const GAS_API_URL = "https://script.google.com/macros/s/AKfycbyKaX7bhCjK3cG2iUwqJrFkYAc_8Q2HCxuQdK67ZS2PLW6eO1dLoJVYdCyHhGUQg54k/exec";

function App() {
  const [projects, setProjects] = React.useState(() => loadProjects());
  const [currentProject, setCurrentProject] = React.useState(Object.keys(loadProjects())[0] || "");
  const [page, setPage] = React.useState("ææ–™");
  const [isSyncing, setIsSyncing] = React.useState(false);
  const [hasUnsavedChanges, setHasUnsavedChanges] = React.useState(false);

  const [materialDB, setMaterialDB] = React.useState([]);
  const [purchaseDB, setPurchaseDB] = React.useState([]);
  const [fabricationDB, setFabricationDB] = React.useState([]);
  const [transportDB, setTransportDB] = React.useState([]);
  const [installDB, setInstallDB] = React.useState([]);

  // --- é›²ç«¯è®€å–ï¼šæ¡ç”¨ã€Œåˆä½µã€è€Œéã€Œè¦†è“‹ã€ ---
  async function loadProjectsFromCloud() {
    setIsSyncing(true);
    try {
      const resp = await fetch(GAS_API_URL);
      const cloudData = await resp.json();
      if (cloudData && typeof cloudData === 'object') {
        setProjects(prev => {
          // ğŸš€ é—œéµï¼šå°‡æœ¬åœ°æœ€æ–°è³‡æ–™èˆ‡é›²ç«¯è³‡æ–™åˆä½µï¼Œç¢ºä¿æœ¬åœ°ä¿®æ”¹å„ªå…ˆ
          const merged = { ...cloudData, ...prev }; 
          saveProjects(merged);
          return merged;
        });
        setHasUnsavedChanges(false);
      }
    } catch (e) { console.error("è¼‰å…¥å¤±æ•—"); }
    finally { setIsSyncing(false); }
  }

  // --- é›²ç«¯å„²å­˜ ---
  async function saveToCloud(projectName, projectDetail) {
    setIsSyncing(true);
    try {
      await fetch(GAS_API_URL, {
        method: "POST",
        body: JSON.stringify({ projectName, data: projectDetail })
      });
      // çµ¦äºˆå°å»¶é²ç¢ºä¿ GAS å¯«å…¥å®Œæˆ
      setTimeout(() => {
        setIsSyncing(false);
        setHasUnsavedChanges(false);
      }, 1000);
    } catch (e) { 
      setIsSyncing(false);
      console.error("å„²å­˜å¤±æ•—"); 
    }
  }

  // [ä¿ç•™åŸæœ¬çš„ loadDB, fetchCSV ...]
  async function fetchCSV(url) {
    const text = await fetch(url).then(r => r.text());
    const rows = text.split("\n").map(r => r.trim());
    const version = `${rows.length}-${rows[0]}-${rows[rows.length - 1]}`;
    return { rows, version };
  }

  async function loadDB(name, url, setter) {
    const local = localStorage.getItem("db_" + name);
    const localV = localStorage.getItem("dbv_" + name);
    const { rows, version } = await fetchCSV(url);
    if (local && localV === version) {
      setter(JSON.parse(local));
    } else {
      const parsed = rows.slice(1).map(r => r.split(",")).filter(r => r.length >= 2).map(r => {
        if (name === "material") return { category: r[0], spec: r[1], unit: r[2], weight: Number(r[3] || 0), price: Number(r[4] || 0) };
        if (name === "purchase") return { category: r[0], spec: r[1], unit: r[2], price: Number(r[3] || 0) };
        if (name === "fabrication") return { category: r[0], spec: r[1], unit: r[2], price: Number(r[3] || 0) };
        if (name === "transport") return { category: r[0], spec: r[1], region: r[2], price: Number(r[3] || 0), unit: r[4] || "å°" };
        if (name === "install") return { category: r[0], spec: r[1], unit: r[2], price: Number(r[3] || 0) };
        return {};
      });
      setter(parsed);
      localStorage.setItem("db_" + name, JSON.stringify(parsed));
      localStorage.setItem("dbv_" + name, version);
    }
  }

  React.useEffect(() => {
    loadDB("material", CSV_URLS.material, setMaterialDB);
    loadDB("purchase", CSV_URLS.purchase, setPurchaseDB);
    loadDB("fabrication", CSV_URLS.fabrication, setFabricationDB);
    loadDB("transport", CSV_URLS.transport, setTransportDB);
    loadDB("install", CSV_URLS.install, setInstallDB);
    loadProjectsFromCloud();
  }, []);

  const projectData = projects[currentProject] || { allItems: [], manualAdjustDetail: {} };

  function updateProjectData(newData) {
    setHasUnsavedChanges(true);
    const updated = { ...projects, [currentProject]: newData };
    setProjects(updated);
    saveProjects(updated);
    saveToCloud(currentProject, newData);
  }

  return (
    <div className="p-4 max-w-5xl mx-auto">
      <div className={`flex justify-between items-center mb-4 p-3 rounded shadow border-l-4 ${isSyncing ? 'bg-orange-50 border-orange-500' : 'bg-green-50 border-green-500'}`}>
        <div className="text-sm font-bold">
          {isSyncing ? "ğŸ”„ é›²ç«¯åŒæ­¥ä¸­..." : "âœ… é›²ç«¯å·²é€£ç·š"}
          {hasUnsavedChanges && <span className="ml-2 text-red-500">(æ–°è³‡æ–™å„²å­˜ä¸­)</span>}
        </div>
        <button onClick={loadProjectsFromCloud} disabled={isSyncing} className="bg-white px-3 py-1 rounded border text-xs hover:bg-gray-50 disabled:opacity-50">åˆ·æ–°è³‡æ–™</button>
      </div>

      <ProjectManager currentProject={currentProject} setCurrentProject={setCurrentProject} projects={projects} setProjects={setProjects} />
      <BackupArea projects={projects} setProjects={setProjects} setCurrentProject={setCurrentProject} />

      <div className="flex gap-2 mb-4">
        {["ææ–™", "å¸‚è³¼å“", "è£½ä½œæˆæœ¬", "é‹è¼¸è²»ç”¨", "ç¾å ´å®‰è£", "ç¸½è¡¨"].map(tab => (
          <button key={tab} onClick={() => setPage(tab)} className={"px-3 py-1 rounded border " + (page === tab ? "bg-blue-600 text-white" : "bg-white")}>{tab}</button>
        ))}
      </div>

      <div className="bg-white rounded shadow p-2">
        {page === "ææ–™" && <MaterialsPage materialDB={materialDB} projectData={projectData} setProjectData={updateProjectData} />}
        {page === "å¸‚è³¼å“" && <PurchasePage purchaseDB={purchaseDB} projectData={projectData} setProjectData={updateProjectData} />}
        {page === "è£½ä½œæˆæœ¬" && <FabricationPage fabricationDB={fabricationDB} projectData={projectData} setProjectData={updateProjectData} />}
        {page === "é‹è¼¸è²»ç”¨" && <TransportPage transportDB={transportDB} projectData={projectData} setProjectData={updateProjectData} />}
        {page === "ç¾å ´å®‰è£" && <InstallPage installDB={installDB} projectData={projectData} setProjectData={updateProjectData} />}
        {page === "ç¸½è¡¨" && <SummaryPage projectData={projectData} currentProject={currentProject} updateProjectData={updateProjectData} />}
      </div>
    </div>
  );
}
/****************************************************
 * æ¸²æŸ“ App
 ****************************************************/
ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>  <!-- â†â†â† é€™å€‹çµæŸ script æ˜¯æ•´ç«™èƒ½å¦æ­£å¸¸æ¸²æŸ“çš„é—œéµ -->
  
</body>
</html>
